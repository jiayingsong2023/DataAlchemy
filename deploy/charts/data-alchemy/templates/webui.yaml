{{- if .Values.webui.enabled -}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webui
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "data-alchemy.labels" . | nindent 4 }}
    app: webui
spec:
  replicas: {{ .Values.webui.replicas }}
  selector:
    matchLabels:
      {{- include "data-alchemy.selectorLabels" . | nindent 6 }}
      app: webui
  template:
    metadata:
      labels:
        {{- include "data-alchemy.selectorLabels" . | nindent 8 }}
        app: webui
    spec:
      serviceAccountName: data-alchemy-sa
      containers:
      - name: webui
        image: {{ .Values.images.core }}
        imagePullPolicy: {{ .Values.images.pullPolicy }}
        command: ["python", "webui/app.py"]
        ports:
          - containerPort: 8000
            name: http
        envFrom:
          - configMapRef:
              name: data-alchemy-config
          - secretRef:
              name: data-alchemy-secrets
        securityContext:
          privileged: true
        volumeMounts:
          - name: shared-data
            mountPath: /app/data
          - name: kfd
            mountPath: /dev/kfd
          - name: dri
            mountPath: /dev/dri
        resources:
          {{- toYaml .Values.webui.resources | nindent 10 }}
        livenessProbe:
          failureThreshold: 10
          httpGet:
            path: /metrics
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 600
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 5
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /metrics
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 60
          periodSeconds: 10
      volumes:
        - name: shared-data
          persistentVolumeClaim:
            claimName: data-alchemy-shared
        - name: kfd
          hostPath:
            path: /dev/kfd
        - name: dri
          hostPath:
            path: /dev/dri
---
apiVersion: v1
kind: Service
metadata:
  name: webui
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "data-alchemy.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: 8000
      targetPort: 8000
      protocol: TCP
      name: http
  selector:
    {{- include "data-alchemy.selectorLabels" . | nindent 4 }}
    app: webui
{{- if .Values.webui.ingress.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: webui
  namespace: {{ .Values.global.namespace }}
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
spec:
  rules:
    - host: {{ .Values.webui.ingress.host }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: webui
                port:
                  number: 8000
{{- end }}
{{- end }}
